From 97a88bde8e5c2fbf14a31bc0ee8a265b0134a9e9 Mon Sep 17 00:00:00 2001
From: Thomas du Boisrouvray <thomas.duboisrouvray@silabs.com>
Date: Thu, 22 May 2025 11:55:38 +0200
Subject: [PATCH] uic: SWPROT-9418: Restore uic_main and create library
 uic_main_testlib

---
 components/uic_main/CMakeLists.txt            | 24 +++++++++++++++++++
 .../src/uic_component_fixtures_array.c        | 10 ++++++++
 2 files changed, 34 insertions(+)

diff --git a/components/uic_main/CMakeLists.txt b/components/uic_main/CMakeLists.txt
index 31e98fe0c8..932568d34d 100644
--- a/components/uic_main/CMakeLists.txt
+++ b/components/uic_main/CMakeLists.txt
@@ -6,12 +6,15 @@ set(UIC_MAIN_SRC
     src/uic_component_fixtures.c
     src/uic_signal_handler.c
     platform/${COMPATIBLE_PLATFORM}/uic_main_externals_platform.c)
+
 set(UIC_MAIN_INCLUDE $<BUILD_INTERFACE:${CMAKE_CURRENT_LIST_DIR}/include/>
                       $<BUILD_INTERFACE:${CURRENT_LIST_DIR}/../../include>)
+
 add_library(uic_main OBJECT ${UIC_MAIN_SRC})
 target_link_libraries(
   uic_main
   uic_log
+  uic_mqtt
   uic_contiki_platform)
 
 target_include_directories(
@@ -24,3 +27,24 @@ install_headers(uic_main uic libuic-dev)
 if(BUILD_TESTING)
   add_subdirectory(test)
 endif()
+
+# ZWAVE_TESTLIB uic_main libary
+
+add_library(uic_main_testlib OBJECT ${UIC_MAIN_SRC})
+target_link_libraries(
+  uic_main_testlib
+  uic_log
+  uic_main_fd
+  uic_contiki_platform)
+
+target_include_directories(
+  uic_main_testlib
+  PUBLIC ${UIC_MAIN_INCLUDE} $<BUILD_INTERFACE:${CMAKE_BINARY_DIR}/include>
+  PRIVATE src/ platform/${COMPATIBLE_PLATFORM}/)
+
+install_headers(uic_main_testlib uic libuic-dev)
+
+target_compile_definitions(
+  uic_main_testlib
+  PRIVATE ZWAVE_TESTLIB)
+
diff --git a/components/uic_main/src/uic_component_fixtures_array.c b/components/uic_main/src/uic_component_fixtures_array.c
index b50402e5d1..4377a71894 100644
--- a/components/uic_main/src/uic_component_fixtures_array.c
+++ b/components/uic_main/src/uic_component_fixtures_array.c
@@ -13,6 +13,10 @@
 
 #include "sl_log.h"
 
+#ifndef ZWAVE_TESTLIB
+#include "uic_mqtt.h"
+#endif
+
 #include "uic_component_fixtures_internal.h"
 #include "uic_signal_handler.h"
 /** Pre-contiki set-up steps.
@@ -30,6 +34,9 @@
  */
 static uic_fixt_setup_step_t uic_fixt_setup_steps_list[]
   = {{uic_signal_handler_setup, "Unify Signal Handler"},
+#ifndef ZWAVE_TESTLIB
+     {uic_mqtt_setup, "Unify MQTT Client"},
+#endif
      {NULL, "Terminator"}};
 
 /** Final tear-down steps.
@@ -42,6 +49,9 @@ static uic_fixt_setup_step_t uic_fixt_setup_steps_list[]
  */
 static uic_fixt_shutdown_step_t uic_fixt_shutdown_steps_list[]
   = {
+#ifndef ZWAVE_TESTLIB
+     {uic_mqtt_teardown, "Unify MQTT Client"},
+#endif
      {NULL, "Terminator"}};
 
 /**
-- 
2.43.0

