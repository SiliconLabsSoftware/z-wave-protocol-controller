From dd30e22f016c1b7b8a8e6a7fc9b1edb16adc06fb Mon Sep 17 00:00:00 2001
From: Thomas du Boisrouvray <thomas.duboisrouvray@silabs.com>
Date: Fri, 28 Mar 2025 16:39:10 +0100
Subject: [PATCH] SWPROT-9418: Restore config functionnality in uic_init

---
 components/uic_main/CMakeLists.txt |  1 +
 components/uic_main/src/uic_init.c | 17 +++++++++++++++++
 2 files changed, 18 insertions(+)

diff --git a/components/uic_main/CMakeLists.txt b/components/uic_main/CMakeLists.txt
index 9eabca21c6..39caa559b4 100644
--- a/components/uic_main/CMakeLists.txt
+++ b/components/uic_main/CMakeLists.txt
@@ -15,6 +15,7 @@ target_link_libraries(
   uic_main
   uic_log
   uic_mqtt
+  uic_config
   uic_stdin
   uic_contiki_platform)
 
diff --git a/components/uic_main/src/uic_init.c b/components/uic_main/src/uic_init.c
index 6e21abc85f..e87f7570e5 100644
--- a/components/uic_main/src/uic_init.c
+++ b/components/uic_main/src/uic_init.c
@@ -23,6 +23,9 @@
 /* Includes from other components */
 #include "uic_version.h"
 #include "sl_log.h"
+#ifndef ZWAVE_TESTLIB
+#include "config.h"
+#endif
 
 /* Includes from this component */
 #include "uic_main.h"
@@ -62,6 +65,20 @@ sl_status_t uic_init(const uic_fixt_setup_step_t *fixt_app_setup,
   /* Import the system configuration. */
   sl_log_info(LOG_TAG, "# Unify build version: %s\n", UIC_VERSION);
   sl_log_info(LOG_TAG, "# Unify build SHA: %s\n", UIC_VERSION_SHA);
+#ifndef ZWAVE_TESTLIB
+  int ret = 0;
+  ret = config_parse(argc, argv, version);
+  if (ret) {
+    if (ret == CONFIG_STATUS_INFO_MESSAGE) {
+      return SL_STATUS_PRINT_INFO_MESSAGE;
+    } else if (ret != CONFIG_STATUS_OK) {
+      sl_log_critical(LOG_TAG, "Cannot initialize UIC Main - goodbye!\n");
+      return SL_STATUS_FAIL;
+    }
+  }
+  // Init log as early as possible after parsing config
+  sl_log_read_config(NULL);
+#endif
   uic_main_contiki_setup();
 
   /* Initialize system components.
-- 
2.43.0

