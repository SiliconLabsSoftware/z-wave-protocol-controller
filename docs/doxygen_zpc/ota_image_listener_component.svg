<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1325px" preserveAspectRatio="none" style="width:872px;height:1325px;background:#FFFFFF;" version="1.1" viewBox="0 0 872 1325" width="872px" zoomAndPan="magnify"><defs><filter height="300%" id="f1p6y6bp1063od" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="255" x="305" y="28.7219">OTA Image Listener component</text><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="357.7996"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="554.3997"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="29.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="730.1997"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="148.0001" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="828.9998"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="1074.1999"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="29.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="1175.3999"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="146.0001" style="stroke:#000000;stroke-width:2.0;" width="749.5" x="98" y="459.9996"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="176" y1="170.5995" y2="612.9997"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="176" x2="176" y1="612.9997" y2="640.9997"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="176" y1="640.9997" y2="640.9997"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="176" x2="176" y1="640.9997" y2="668.9997"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="176" y1="668.9997" y2="984.9998"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="176" x2="176" y1="984.9998" y2="1012.9998"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="176" y1="1012.9998" y2="1125.7999"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="176" x2="176" y1="1125.7999" y2="1153.7999"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="176" y1="1153.7999" y2="1282.1999"/><line style="stroke:#A80036;stroke-width:1.0;" x1="552.5" x2="552.5" y1="170.5995" y2="612.9997"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="552.5" x2="552.5" y1="612.9997" y2="640.9997"/><line style="stroke:#A80036;stroke-width:1.0;" x1="552.5" x2="552.5" y1="640.9997" y2="640.9997"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="552.5" x2="552.5" y1="640.9997" y2="668.9997"/><line style="stroke:#A80036;stroke-width:1.0;" x1="552.5" x2="552.5" y1="668.9997" y2="984.9998"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="552.5" x2="552.5" y1="984.9998" y2="1012.9998"/><line style="stroke:#A80036;stroke-width:1.0;" x1="552.5" x2="552.5" y1="1012.9998" y2="1125.7999"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="552.5" x2="552.5" y1="1125.7999" y2="1153.7999"/><line style="stroke:#A80036;stroke-width:1.0;" x1="552.5" x2="552.5" y1="1153.7999" y2="1282.1999"/><line style="stroke:#A80036;stroke-width:1.0;" x1="784.5" x2="784.5" y1="170.5995" y2="612.9997"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="784.5" x2="784.5" y1="612.9997" y2="640.9997"/><line style="stroke:#A80036;stroke-width:1.0;" x1="784.5" x2="784.5" y1="640.9997" y2="640.9997"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="784.5" x2="784.5" y1="640.9997" y2="668.9997"/><line style="stroke:#A80036;stroke-width:1.0;" x1="784.5" x2="784.5" y1="668.9997" y2="984.9998"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="784.5" x2="784.5" y1="984.9998" y2="1012.9998"/><line style="stroke:#A80036;stroke-width:1.0;" x1="784.5" x2="784.5" y1="1012.9998" y2="1125.7999"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="784.5" x2="784.5" y1="1125.7999" y2="1153.7999"/><line style="stroke:#A80036;stroke-width:1.0;" x1="784.5" x2="784.5" y1="1153.7999" y2="1282.1999"/><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.7999" style="stroke:#A80036;stroke-width:1.5;" width="132" x="108" y="134.7996"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="118" x="115" y="154.8055">Protocol Controller</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.7999" style="stroke:#A80036;stroke-width:1.5;" width="132" x="108" y="1281.1999"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="118" x="115" y="1301.2059">Protocol Controller</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.7999" style="stroke:#A80036;stroke-width:1.5;" width="43" x="529.5" y="134.7996"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="536.5" y="154.8055">OTA</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.7999" style="stroke:#A80036;stroke-width:1.5;" width="43" x="529.5" y="1281.1999"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="536.5" y="1301.2059">OTA</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.7999" style="stroke:#A80036;stroke-width:1.5;" width="101" x="732.5" y="134.7996"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="739.5" y="154.8055">MQTT Broker</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.7999" style="stroke:#A80036;stroke-width:1.5;" width="101" x="732.5" y="1281.1999"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="739.5" y="1301.2059">MQTT Broker</text><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="357.7996"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="554.3997"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="29.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="730.1997"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="148.0001" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="828.9998"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="1074.1999"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="29.6" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548" y="1175.3999"/><path d="M292,185.5995 L292,257.5995 L809,257.5995 L809,195.5995 L799,185.5995 L292,185.5995 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M799,185.5995 L799,195.5995 L809,195.5995 L799,185.5995 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="298" y="202.6765">- 'image_available' callback with data containing meta data the newly available image.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="335" x="298" y="218.2765">- 'image_base_path' path used to download the images to.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="496" x="298" y="233.8765">- 'cache_size' defines the max amount of images to be cached by the ota component.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="399" x="298" y="249.4766">- 'timeout' the time before a get function returns with result TIMEOUT</text><polygon fill="#A80036" points="541,284.5996,551,288.5996,541,292.5996,545,288.5996" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="547" y1="288.5996" y2="288.5996"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="353" x="183" y="283.0766">init(image_available, image_base_path, cache_size, timeout)</text><path d="M323,301.5996 L323,326.5996 L778,326.5996 L778,311.5996 L768,301.5996 L323,301.5996 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M768,301.5996 L768,311.5996 L778,311.5996 L768,301.5996 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="434" x="329" y="318.6766">we have 2 ways to subscribe for images; 1. via uiid 2. via unid's (uiid, unid)</text><polygon fill="#A80036" points="536,353.7996,546,357.7996,536,361.7996,540,357.7996" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="542" y1="357.7996" y2="357.7996"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="183" y="352.2766">subscribe_uiid(uiid)</text><polygon fill="#A80036" points="773,383.3996,783,387.3996,773,391.3996,777,387.3996" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="558" x2="779" y1="387.3996" y2="387.3996"/><text fill="#0039FB" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="565" y="381.8766">ucl/OTA/info/&lt;UIID&gt;/all</text><polygon fill="#A80036" points="187,397.3996,177,401.3996,187,405.3996,183,401.3996" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="181" x2="552" y1="401.3996" y2="401.3996"/><rect fill="#EEEEEE" filter="url(#f1p6y6bp1063od)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="865" x="0" y="430.1996"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="865" y1="430.1996" y2="430.1996"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="865" y1="433.1996" y2="433.1996"/><rect fill="#EEEEEE" filter="url(#f1p6y6bp1063od)" height="23.6" style="stroke:#000000;stroke-width:2.0;" width="113" x="376" y="419.3996"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="95" x="382" y="435.4766">node discovery</text><path d="M98,459.9996 L171,459.9996 L171,466.9996 L161,476.9996 L98,476.9996 L98,459.9996 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="146.0001" style="stroke:#000000;stroke-width:2.0;" width="749.5" x="98" y="459.9996"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="28" x="113" y="473.0766">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="148" x="186" y="472.2185">[for n nodes in the network]</text><path d="M302,482.5996 L302,523.5996 L799,523.5996 L799,492.5996 L789,482.5996 L302,482.5996 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M789,482.5996 L789,492.5996 L799,492.5996 L789,482.5996 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="476" x="308" y="499.6766">The PC is responsible to obtian nodes and their corresponding fwk versioning info.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="434" x="308" y="515.2767">Secondly, it needs to tell us when a node is not part of a network anymore.</text><polygon fill="#A80036" points="536,550.3997,546,554.3997,536,558.3997,540,554.3997" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="542" y1="554.3997" y2="554.3997"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="183" y="548.8767">subscribe_unid(unid, uiid)</text><polygon fill="#A80036" points="773,579.9997,783,583.9997,773,587.9997,777,583.9997" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="558" x2="779" y1="583.9997" y2="583.9997"/><text fill="#0039FB" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170" x="565" y="578.4767">ucl/OTA/info/&lt;UIID&gt;/&lt;UNID&gt;</text><polygon fill="#A80036" points="187,593.9997,177,597.9997,187,601.9997,183,597.9997" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="181" x2="552" y1="597.9997" y2="597.9997"/><path d="M709,673.9997 L709,698.9997 L856,698.9997 L856,683.9997 L846,673.9997 L709,673.9997 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M846,673.9997 L846,683.9997 L856,683.9997 L846,673.9997 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="715" y="691.0767">new image coming in!</text><polygon fill="#A80036" points="569,726.1997,559,730.1997,569,734.1997,565,730.1997" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="563" x2="784" y1="730.1997" y2="730.1997"/><text fill="#00003C" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="575" y="724.6767">ucl/OTA/info/&lt;UIID&gt;/all/+</text><polygon fill="#A80036" points="187,755.7997,177,759.7997,187,763.7997,183,759.7997" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="181" x2="552" y1="759.7997" y2="759.7997"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="305" x="193" y="754.2767">image_available(uiid, unid, new_version, apply_after)</text><path d="M38,772.7997 L38,797.7997 L309,797.7997 L309,782.7997 L299,772.7997 L38,772.7997 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M299,772.7997 L299,782.7997 L309,782.7997 L299,772.7997 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="250" x="44" y="789.8767">protocol controller decides to get the image</text><polygon fill="#A80036" points="536,824.9998,546,828.9998,536,832.9998,540,828.9998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="542" y1="828.9998" y2="828.9998"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="183" y="823.4768">get(uiid, image_ready_cb)</text><polygon fill="#A80036" points="773,854.5998,783,858.5998,773,862.5998,777,858.5998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="558" x2="779" y1="858.5998" y2="858.5998"/><text fill="#0039FB" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="565" y="853.0768">ucl/OTA/data/&lt;UIID&gt;</text><polygon fill="#A80036" points="773,884.1998,783,888.1998,773,892.1998,777,888.1998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="558" x2="779" y1="888.1998" y2="888.1998"/><text fill="#6C2A0D" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="565" y="882.6768">ucl/OTA/data/&lt;UIID&gt;/get</text><polygon fill="#A80036" points="569,913.7998,559,917.7998,569,921.7998,565,917.7998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="563" x2="784" y1="917.7998" y2="917.7998"/><text fill="#6C2A0D" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="575" y="912.2768">ucl/OTA/data/&lt;UIID&gt;</text><polygon fill="#A80036" points="773,943.3998,783,947.3998,773,951.3998,777,947.3998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="558" x2="779" y1="947.3998" y2="947.3998"/><text fill="#2B3618" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="569" y="941.8768">ucl/OTA/data/&lt;UIID&gt;</text><polygon fill="#A80036" points="187,972.9998,177,976.9998,187,980.9998,183,976.9998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="181" x2="552" y1="976.9998" y2="976.9998"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="193" y="971.4768">image_ready_cb(image_meta)</text><path d="M5,1017.9998 L5,1042.9998 L343,1042.9998 L343,1027.9998 L333,1017.9998 L5,1017.9998 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M333,1017.9998 L333,1027.9998 L343,1027.9998 L333,1017.9998 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="11" y="1035.0768">protocol controller sends updates to the image_listener</text><polygon fill="#A80036" points="536,1070.1999,546,1074.1999,536,1078.1999,540,1074.1999" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="542" y1="1074.1999" y2="1074.1999"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="263" x="183" y="1068.6769">update_*status*(uiid, unid, endpoint, *status*)</text><polygon fill="#A80036" points="773,1099.7999,783,1103.7999,773,1107.7999,777,1103.7999" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="558" x2="779" y1="1103.7999" y2="1103.7999"/><text fill="#00003C" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="565" y="1098.2769">ucl/by-unid/&lt;UNID&gt;/OTA/&lt;UIID&gt;/+</text><polygon fill="#A80036" points="187,1113.7999,177,1117.7999,187,1121.7999,183,1117.7999" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="181" x2="552" y1="1117.7999" y2="1117.7999"/><polygon fill="#A80036" points="536,1171.3999,546,1175.3999,536,1179.3999,540,1175.3999" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="542" y1="1175.3999" y2="1175.3999"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="183" y="1169.8769">unregister_unid(unid)</text><polygon fill="#A80036" points="773,1200.9999,783,1204.9999,773,1208.9999,777,1204.9999" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="553" x2="779" y1="1204.9999" y2="1204.9999"/><text fill="#00003C" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="560" y="1199.4769">ucl/by-unid/&lt;UNID&gt;/OTA/&lt;UIID&gt;/+</text><polygon fill="#A80036" points="541,1230.5999,551,1234.5999,541,1238.5999,545,1234.5999" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="547" y1="1234.5999" y2="1234.5999"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="183" y="1229.0769">unregister(uiid)</text><polygon fill="#A80036" points="541,1260.1999,551,1264.1999,541,1268.1999,545,1264.1999" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="176" x2="547" y1="1264.1999" y2="1264.1999"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="183" y="1258.6769">clear_cache()</text><rect fill="#DDDDDD" height="77.1997" rx="5" ry="5" style="stroke:#000000;stroke-width:1.0;" width="200" x="332" y="48.5999"/><text fill="#0039FB" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123" x="338" y="66.6058">MQTT Subscription</text><text fill="#2B3618" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="124" x="338" y="83.4057">MQTT Unsubscribe</text><text fill="#00003C" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175" x="338" y="100.2057">Retained MQTT Publication</text><text fill="#6C2A0D" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="188" x="338" y="117.0056">Unretained MQTT Publication</text><!--MD5=[45629a1bc0a63ccbe498fc3aa546f17a]
@startuml ota_image_listener_component.svg
title OTA Image Listener component
legend top
<font color=#0039FB>MQTT Subscription</font>
<font color=#2b3618>MQTT Unsubscribe</font>
<font color=#00003C>Retained MQTT Publication</font>
<font color=#6C2A0D>Unretained MQTT Publication</font>
endlegend

participant "Protocol Controller" as PC
participant "OTA" as IL
participant "MQTT Broker" as MQTT

note over IL
- 'image_available' callback with data containing meta data the newly available image.
- 'image_base_path' path used to download the images to.
- 'cache_size' defines the max amount of images to be cached by the ota component.
- 'timeout' the time before a get function returns with result TIMEOUT
end note
PC-> IL: init(image_available, image_base_path, cache_size, timeout)
note over IL: we have 2 ways to subscribe for images; 1. via uiid 2. via unid's (uiid, unid)
PC->IL:subscribe_uiid(uiid)
activate IL
IL->MQTT:<font color=#0039FB>ucl/OTA/info/<UIID>/all</font>
IL- ->PC
deactivate IL
== node discovery ==
loop for n nodes in the network
note over IL
The PC is responsible to obtian nodes and their corresponding fwk versioning info.
Secondly, it needs to tell us when a node is not part of a network anymore.
end note
PC->IL:subscribe_unid(unid, uiid)
activate IL
IL->MQTT:<font color=#0039FB>ucl/OTA/info/<UIID>/<UNID></font>
IL- ->PC
deactivate IL
end
...
...
note over MQTT: new image coming in!
MQTT->IL: <font color=#00003C>ucl/OTA/info/<UIID>/all/+</font>
activate IL
IL->PC:image_available(uiid, unid, new_version, apply_after)
deactivate IL
note over PC: protocol controller decides to get the image
PC->IL: get(uiid, image_ready_cb)
activate IL
IL->MQTT:<font color=#0039FB>ucl/OTA/data/<UIID></font>
IL->MQTT:<font color=#6C2A0D>ucl/OTA/data/<UIID>/get</font>
MQTT->IL:<font color=#6C2A0D>ucl/OTA/data/<UIID></font>
IL->MQTT:<font color=#2b3618> ucl/OTA/data/<UIID></font>
IL->PC: image_ready_cb(image_meta)
deactivate IL

...
note over PC: protocol controller sends updates to the image_listener
PC->IL: update_*status*(uiid, unid, endpoint, *status*)
activate IL
IL-> MQTT: <font color=#00003C>ucl/by-unid/<UNID>/OTA/<UIID>/+
IL- ->PC
deactivate IL
...

PC->IL:unregister_unid(unid)
activate IL
IL-> MQTT: <font color=#00003C>ucl/by-unid/<UNID>/OTA/<UIID>/+
deactivate IL
PC->IL: unregister(uiid)
PC->IL: clear_cache()
@enduml

PlantUML version 1.2022.0(Tue Jan 11 16:16:42 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: ANSI_X3.4-1968
Language: en
Country: US
--></g></svg>